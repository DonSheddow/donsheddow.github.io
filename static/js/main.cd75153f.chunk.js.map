{"version":3,"sources":["crashing_iframe.js","index.js"],"names":["IFRAME_URL","KB","MB","GB","wait","_callee","ms","regenerator_default","a","wrap","_context","prev","next","abrupt","Promise","resolve","setTimeout","stop","wait_until_frame_has_crashed","_callee2","_context2","window","frames","length","wait_until_frame_has_loaded","_callee3","_context3","ensure_iframe","_callee4","f","has_loaded","_context4","document","createElement","src","onload","body","appendChild","reload_iframe","_callee5","_context5","location","get_count","_callee6","url","alloc_size","count","msg_handler","_context6","event","data","addEventListener","postMessage","action","removeEventListener","get_samples","_callee7","n","samples","i","_args7","arguments","_context7","undefined","t0","t1","sent","push","call","tune_for_url","_callee8","initial_size","target","precision","size","measurement","step","prev_size","_args8","_context8","measure","pretty_print_size","console","log","gb","Math","floor","mb","kb","concat","_callee9","_context9","performance","now","sort","b","_callee10","res","_args10","_context10","URLInput","props","_this","Object","classCallCheck","this","possibleConstructorReturn","getPrototypeOf","id","uniqueId","react_default","htmlFor","label","className","type","defaultValue","onChange","children","React","Component","App","_this2","calibrate","setState","loadingState","state","calibrationUrl","allocSize","then","_ref","baseMeasurement","testUrl","diff","abs","equal","setCalibrationUrl","e","value","setTestUrl","src_URLInput","onClick","ReactDOM","render","src_App","getElementById"],"mappings":"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","file":"static/js/main.cd75153f.chunk.js","sourcesContent":["const IFRAME_URL = \"https://notsheddow.xyz/resp_clone/iframe.html\"\n\nconst KB = 1024;\nconst MB = 1024*1024;\nconst GB = 1024*1024*1024;\n\nasync function wait(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nasync function wait_until_frame_has_crashed() {\n    while (window.frames[0].frames.length > 0) {\n        await wait(1);\n    }\n}\n\nasync function wait_until_frame_has_loaded() {\n    while (window.frames[0].frames.length === 0) {\n        await wait(1);\n    }\n}\n\nasync function ensure_iframe() {\n    if (window.frames.length === 0) {\n        let f = document.createElement('iframe');\n        f.src = IFRAME_URL;\n        let has_loaded = new Promise(resolve => { f.onload = resolve });\n        document.body.appendChild(f);\n        await has_loaded;\n    }\n}\n\nasync function reload_iframe() {\n    window.frames[0].location = \"about:blank\";\n    await wait(50);\n    window.frames[0].location = IFRAME_URL\n    await wait_until_frame_has_loaded();\n}\n\nasync function get_count(url, alloc_size) {\n    let count = 0;\n    function msg_handler(event) {\n        count = event.data;\n    }\n\n    window.addEventListener(\"message\", msg_handler);\n    window.frames[0].postMessage({action: \"clone_until_crash\", url, alloc_size}, \"*\");\n    await wait_until_frame_has_crashed();\n    window.removeEventListener(\"message\", msg_handler);\n\n    await reload_iframe();\n    return count;\n}\n\nasync function get_samples(url, alloc_size, n = 5) {\n    let samples = [];\n    for (let i = 0; i < n; i++) {\n        samples.push(await get_count(url, alloc_size));\n    }\n    return samples;\n}\n\nasync function tune_for_url(url, initial_size, target = 75) {\n    let precision = 15;\n    let size = initial_size;\n    let measurement = await measure(url, size);\n    let step = 20*MB;\n    while (measurement === 0) {\n        size -= step;\n        step += 2*MB;\n        measurement = await measure(url, size);\n        pretty_print_size(size);\n        console.log(measurement);\n    }\n    let prev_size = size;\n    while (measurement < target - precision || measurement > target + precision) {\n        let error = target - measurement;\n        size += -80*KB*error;\n        size = (size + prev_size)/2;\n        prev_size = size;\n\n        measurement = await measure(url, size);\n        pretty_print_size(size);\n        console.log(measurement);\n    }\n\n    return {size, count: measurement};\n}\n\nfunction pretty_print_size(size) {\n    let gb = Math.floor(size / GB);\n    let mb = Math.floor((size % GB) / MB);\n    let kb = Math.floor((size % MB) / KB);\n    console.log(`size: ${gb} GB + ${mb} MB + ${kb} KB`);\n}\n\nasync function measure(url, alloc_size) {\n    await ensure_iframe();\n    let t0 = window.performance.now();\n    let samples = await get_samples(url, alloc_size, 3);\n    console.log(`elapsed: ${window.performance.now() - t0}`);\n    console.log(samples);\n    samples.sort((a, b) => a-b);\n    return samples[1];\n}\n\nasync function calibrate(url, initial_size = undefined) {\n    await ensure_iframe();\n    let t0 = window.performance.now();\n    if (!initial_size) {\n        initial_size = 4*GB;\n    }\n    console.log(\"Tuning...\");\n    let res = await tune_for_url(url, initial_size);\n    console.log(`elapsed for tuning: ${window.performance.now() - t0}`);\n    return res;\n}\n\nexport {calibrate, measure};\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport { uniqueId } from 'lodash';\n\nimport { calibrate, measure } from './crashing_iframe';\n\nclass URLInput extends React.Component {\n    constructor(props) {\n        super(props);\n        this.id = uniqueId('urlinput_');\n    }\n\n    render() {\n        return (\n            <div>\n                <label htmlFor={this.id}>{this.props.label}</label>\n                <input id={this.id} className=\"url-input\" type=\"text\" defaultValue={this.props.url} onChange={this.props.onChange}></input>\n                {this.props.children}\n            </div>\n        );\n    }\n}\n\nclass App extends React.Component {\n    constructor(props) {\n        super(props);\n        this.state = {\n            allocSize: null,\n            calibrationUrl: \"https://sheddow.xyz/flask/bytes?len=1000\",\n            testUrl: \"https://sheddow.xyz/flask/bytes?len=1025\",\n            loadingState: null,\n            baseMeasurement: null,\n            measurement: null,\n        };\n    }\n\n    componentDidMount() {\n        this.calibrate();\n    }\n\n    calibrate = () => {\n        this.setState({loadingState: \"Calibrating...\"});\n        calibrate(this.state.calibrationUrl, this.state.allocSize).then(({size, count}) => {\n            this.setState({loadingState: null, allocSize: size, baseMeasurement: count});\n        });\n    }\n\n    measure = () => {\n        this.setState({loadingState: \"Measuring...\"});\n        measure(this.state.testUrl, this.state.allocSize).then(count => {\n            this.setState({loadingState: null, measurement: count});\n            let diff = Math.abs(this.state.measurement - this.state.baseMeasurement);\n            if (diff <= 0.3*this.state.measurement || diff <= 0.3*this.state.baseMeasurement) {\n                this.setState({equal: true});\n            }\n            else {\n                this.setState({equal: false});\n            }\n        });\n    }\n\n    setCalibrationUrl = (e) => {\n        this.setState({calibrationUrl: e.target.value});\n    }\n\n    setTestUrl = (e) => {\n        this.setState({testUrl: e.target.value});\n    }\n\n    render() {\n        return (\n            <div>\n                <URLInput label=\"Base URL\" url={this.state.calibrationUrl} onChange={this.setCalibrationUrl}>\n                    <span className=\"measurement\">{this.state.baseMeasurement}</span>\n                    { \n                        this.state.loadingState ?\n                        this.state.loadingState : \n                        <button onClick={this.calibrate}>Calibrate</button>\n                    }\n                </URLInput>\n                <URLInput label=\"Test URL\" url={this.state.testUrl} onChange={this.setTestUrl}>\n                    <span className=\"measurement\">{this.state.measurement}</span>\n                    { \n                        this.state.loadingState ?\n                        this.state.loadingState : \n                        <button onClick={this.measure}>Measure</button>\n                    }\n                </URLInput>\n                {\n                    this.state.measurement !== null && this.state.baseMeasurement !== null ?\n                    (\n                        this.state.equal ? \n                        <span className=\"equal\">Equal</span> :\n                        <span className=\"not-equal\">Not Equal</span>\n                    ) :\n                    null\n                }\n            </div>\n        );\n    }\n}\n\n// ========================================\n\nReactDOM.render(\n  <App />,\n  document.getElementById('root')\n);\n"],"sourceRoot":""}